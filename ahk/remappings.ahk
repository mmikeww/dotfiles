
;// my keyboard (thinkpad w530), standard qwerty with the remaps listed

;
; Legend:
;
;   ┌────────────────────────┐
;   │                        │
;   │ shift +     shift +    │
;   │ key         Alt + key  │
;   │                        │
;   │                        │
;   │ normal       Alt +     │
;   │ key          key       │
;   │                        │
;   └────────────────────────┘
;
;

;┌───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬────────────┐
;│ ~     │ !     │ @     │ #     │ $     │ %     │ ^     │ &     │ *     │ (     │ )     │ _     │ +     │            │
;│ `     │ 1     │ 2     │ 3     │ 4   £ │ 5   € │ 6     │ 7     │ 8     │ 9     │ 0     │ -     │ =     │ Backspace  │
;├───────┴─┬─────┴─┬─────┴─┬─────┴─┬─────┴─┬─────┴─┬─────┴─┬─────┴─┬─────┴─┬─────┴─┬─────┴─┬─────┴─┬─────┴─┬──────────┤
;│         │ Q     │ W     │ E     │ R     │ T     │ Y     │ U     │ I     │ O     │ P     │ {     │ }     │ |        │
;│ Tab     │       │       │    End│       │       │       │       │       │       │       │ [     │ ]     │ \        │
;├─────────┴──┬────┴──┬────┴──┬────┴──┬────┴──┬────┴──┬────┴──┬────┴──┬────┴──┬────┴──┬────┴──┬────┴──┬────┴──────────┤
;│            │ A     │ S     │ D     │ F     │ G     │ H     │ J     │ K     │ L     │ :     │ "     │               │
;│ Capslock   │   Home│       │       │       │       │       │       │       │       │ ;     │ '     │  Enter        │ 
;├────────────┴──┬────┴──┬────┴──┬────┴──┬────┴──┬────┴──┬────┴──┬────┴──┬────┴──┬────┴──┬────┴──┬────┴───────────────┤
;│               │ Z     │ X     │ C     │ V     │ B     │ N     │ M     │ <     │ >     │ ?     │                    │
;│ Shift         │       │       │       │       │       │       │       │ ,     │ .     │ /     │   Shift            │
;├──────┬────────┼───────┼───────┼───────┴───────┴───────┴───────┴───────┼───────┼───────┼───────┼────────────────────┘
;│      │        │       │       │                                       │       │       │       │
;│ Fn   │ Ctrl   │ Win   │ Alt   │             Spacebar                  │ Alt   │ PrtSc │ Ctrl  │ 
;└──────┴────────┴───────┴───────┴───────────────────────────────────────┴───────┴───────┴───────┘


; unicode characters used to draw the diagram:  ─ │ ┌ ┐ └ ┘ ├ ┤ ┬ ┴ ┼

; 
; alternatively, using keyboard-layout-creator.com
;
; default w530 keyboard:
; http://www.keyboard-layout-editor.com/#/layouts/ae55dc3c6b6c80904d0901d856247486
; or
; http://www.keyboard-layout-editor.com/##@@=~%0A%60&=!%0A1&=%2F@%0A2&=%23%0A3&=$%0A4&=%25%0A5&=%5E%0A6&=%2F&%0A7&=*%0A8&=(%0A9&=)%0A0&=%2F_%0A-&=+%0A%2F=&_a:6&w:2%3B&=%0A%0ABackspace%3B&@_w:1.5%3B&=Tab&_a:4%3B&=Q&=W&=E&=R&=T&=Y&=U&=I&=O&=P&=%7B%0A%5B&=%7D%0A%5D&_w:1.5%3B&=%7C%0A%5C%3B&@_a:6&w:1.75%3B&=Caps%20Lock&_a:4%3B&=A&=S&=D&=F&=G&=H&=J&=K&=L&=%2F:%0A%2F%3B&=%22%0A'&_a:6&w:2.25%3B&=%0A%0AEnter%3B&@_w:2.25%3B&=Shift&_a:4%3B&=Z&=X&=C&=V&=B&=N&=M&=%3C%0A,&=%3E%0A.&=%3F%0A%2F%2F&_a:6&w:2.75%3B&=%0A%0AShift%3B&@=Fn&_w:1.25%3B&=Ctrl&=Win&=Alt&_a:4&w:5%3B&=&_a:6%3B&=Alt&=PrtSc&=Ctrl
;
; alt key layout:
; http://www.keyboard-layout-editor.com/#/layouts/bf935568977b46707a893188942e4140
; or
; http://www.keyboard-layout-editor.com/##@@_g:true%3B&=&=&=&=&=&=&=&=&=&=&=&=&=&_a:6&w:2%3B&=%0A%0ABackspace%3B&@_w:1.5%3B&=Tab&_t=%23ff0000&a:4%3B&=&=&_g:false%3B&=%0A%0A%0A%0A%0A%0AEnd&_g:true%3B&=&=&=&=&=&=&=&=&=&_t=%23000000&w:1.5%3B&=%3B&@_a:6&w:1.75%3B&=Caps%20Lock&_c=%23c0c0c0&t=%23ff0000&g:false&a:4%3B&=%0A%0A%0A%0A%0A%0AHome&=&=&=%0A%0A%0A%0A%0A%0ABksp&_c=%23cccccc&g:true%3B&=&=&_c=%23c0c0c0&g:false%3B&=&=&=&=&_c=%23cccccc&g:true%3B&=&_t=%23000000&a:6&w:2.25%3B&=%0A%0AEnter%3B&@_w:2.25%3B&=Shift&_t=%23ff0000&a:4%3B&=&=&=&=&=&=&=&=&=&=&_t=%23000000&a:6&w:2.75%3B&=%0A%0AShift%3B&@=Fn&_w:1.25%3B&=Ctrl&=Win&_c=%23ff8080&g:false%3B&=Alt&_c=%23cccccc&g:true&a:4&w:5%3B&=&_c=%23ff8080&g:false&a:6%3B&=Alt&_c=%23cccccc&g:true%3B&=PrtSc&=Ctrl


#NoEnv
SetTitleMatchMode, RegEx
SetBatchLines, -1
SetKeyDelay, -1
ListLines, off
SendMode, Input


;// if i'm HOLDING the LShift down, its because i plan to capitalize a letter
;// sometimes, i'm holding LShift down, and thinking, perhaps planning to capitalize but then change my mind
;// if i then release LShift, i don't want the ( to be sent
;// if i'm planning on sending ( when i press LShift, then i will be tapping the LShift key fast and releasing fast, like a normal char

; timeout := 300


;// display helper image when i hold down Alt - useful while learning

/*
Gui, 1: +AlwaysOnTop +ToolWindow -Border
Gui, 1: Margin, 0, 0
Gui, 1: Add, Pic, vKeyboardPic, %A_ScriptDir%\LayoutAlt.jpg
Gui, 1: +LastFound
;WinSet, Transparent, 200

;SetTimer, DisplayGraphic, 250
*/


;// display caps lock state
/*
Gui, 2: +AlwaysOnTop +ToolWindow -Border
Gui, 2: Margin, 0, 0
Gui, 2: Font, cRed s36 bold, Tahoma
Gui, 2: Add, Text,, CAPS LOCK ON
*/


EnvGet, TEMP_DIR, TEMP

return            ;// end of auto exec



#IfWinActive TypeRacer - ahk_class Chrome_WidgetWin_1
   ^1::
   ^2::
   ^3::
   ^a::
   ^s::
   ^e::
   ^r::
   ^t::
   ^n::
   ^+w::
   return

   ^Backspace::Send, ^a{Backspace}

   ^w::Send, ^a{Backspace}
#IfWinActive



;// fix notepad
#IfWinActive ahk_class Notepad
   ^Backspace::Send, ^+{Left}{Backspace}
   ^w::Send, ^+{Left}{Backspace}
#IfWinActive


;// ctrl+w deletes prev word as in vim/emacs/etc
;// this will override chrome's close tab shortcut - can use ctrl-f4 instead
;// however these interfere with vim, ctrl+W navigates between windows
;// i could do  #IfWinNotActive, ahk_class Vim  but then i'm learning two muscle memories?
;// or maybe i should change git bash to use vi mode. but that won't work for normal windows edit boxes
;^u::Send, +{Home}{Backspace}   ;// but Ctrl+U is used to underline just like Ctrl+B is used to bold
;// https://support.microsoft.com/en-us/help/126449/keyboard-shortcuts-for-windows
#IfWinNotActive, ahk_class Vim|mintty
   ;^w::Send, ^+{Left}{Backspace} ;// BUT THIS IS A PROBLEM WHEN USING VIM INSIDE VIRTUALBOX
   ^w::Send, ^{Backspace}
#IfWinNotActive


#IfWinActive ahk_class mintty
   ^Backspace::Send, ^w
#IfWinActive



;// incase the paste back fails from the edit w/ Vim below
#n::Run, Notepad.exe %TEMP_DIR%\tmp_vim.txt

;// launch vim to edit things like in webbrowser text boxes or emails
;// also have a hotkey where it doesn't select-all when pasting back
#b::    ; pastes back at the top (emails etc)
#v::    ; pastes over everything
   prev_active_win := WinExist("A")
   fname := TEMP_DIR . "\tmp_vim.txt"
   saved_clipboard := ClipboardAll
   Clipboard := ""
   ;MsgBox, %A_CaretX%  %A_CaretY%
   Send, ^a
   Send, ^c
   ClipWait
   Clipboard = %Clipboard%   ; Convert any copied files, HTML, or other formatted text to plain text
   FileDelete, %fname%
   FileAppend, %Clipboard%, %fname%, UTF-8
   Clipboard := ""
   SetTimer, ActivateVim, -500    ; incase vim isn't being brought to the top. maybe because of Win+ hotkey?
   FileGetTime, ftime_pre, %fname%, M
   RunWait, C:\Program Files (x86)\Vim\vim80\gvim.exe %fname% ;,, Max
   FileGetTime, ftime_post, %fname%, M
   if (ftime_pre == ftime_post)    ; dont paste back if no changes
      return
   FileRead, Clipboard, %fname%
   Clipboard := RegExReplace(Clipboard, "`r`n$", "") ; remove ending new line because FileRead adds one
   WinActivate, ahk_id %prev_active_win%
   WinWaitActive, ahk_id %prev_active_win%
   if (A_ThisHotkey = "#v")
      Send, ^a                           ; use #v to paste over existing text
   else if (A_ThisHotkey = "#b")
      Send, ^{home}                     ; use #b to paste at top, as in email replys
   Send, ^v
   Sleep, 100               ; allow the ^v time to complete before restoring the old clipboard
   Clipboard := saved_clipboard
   saved_clipboard =              ; Free the memory in case the clipboard was very large.
return


ActivateVim:
   WinActivate, tmp_vim.txt ahk_class Vim
return


;// use right shift + capslock to toggle capslock state
/*
from docs:
Makes Capslock become a Control key. To retain the ability to turn Capslock on and off, also add the remapping +Capslock::Capslock (this toggles Capslock on and off when you hold down the shift key and press Capslock).

should read: add the remapping +Capslock BEFORE the capslock remapping
*/


/*

i guess I can just use backspace for CAPSLOCK whenever i want to type in CAPS
that shouldnt be TOO hard of an adjustment

it is a LONG ass move though

then again this STUPID shift mapping is causing problems in virtualbox

so perhaps i should move the parens to another ALT keypress


or, just exclude all of these hotkeys from working inside virtualbox
#IfWinNotActive, VirtualBox ahk_class QWidget
and then just duplicate the script and run it inside the VM also 
*/


;// make RShift+Caps the normal capslock behavior
; $>+Capslock::Capslock

;// remap caps to backspace
; $CapsLock::Backspace

/*
$+CapsLock::
   SetCapslockState % GetKeyState("Capslock", "T") ? "off" : "on"
return



;// while i'm training, remap backspace to NO OP so that i dont press it by mistake just for now
;$Backspace::Capslock
$Backspace::
   capslock_is_on := GetKeyState("Capslock", "T")
   if (capslock_is_on)
   {
      SetCapslockState, off
      Gui, 2: Hide
   }
   else
   {
      SetCapslockState, on
      Gui, 2: Show, % "x" A_ScreenWidth-500 " y" A_ScreenHeight-300 " NoActivate"
   }
return
*/

/*
RAlt & e::Send, {Raw}{
RAlt & r::Send, {Raw}}
*/



;// or a hotstring such as 'f for [ and 'j for ]
;// but these conflict with vims ' command which jumps to mark: `ma` to set mark and then  'a to jump to it
;// using * option to not require endchar, then i can't quote a string with single quotes starting with an f or j such as 'jump high'

; :?O:'f::[
; :?O:'j::]




;// alt/ctrl hjkl for arrow keys ala vim?

;// these two are from US-International layout
;// https://en.wikipedia.org/wiki/QWERTY#US-International
!5::Send, €
!4::Send, £

;// emacs/readline/cmdprompt uses ctrl+A and ctrl+E, but ctrl+A would interfere with 'select all', so ill use alt for these
;// vim already has these shortcuts bound to ^ and $
!a::Send, {Home} ; dont remap it directly with !a::Home because then alt remains held down, sending an Alt+Home keypress
!+a::Send, +{Home}
!e::Send, {End}
!+e::Send, +{End}

/*
>!e::Send, {Raw}{
>!r::Send, {Raw}}
;<!j::Send, 1
!j::Backspace
>!w::Send, {Raw}+
>!c::Send, [
>!v::Send, ]
<!k::Send, 0
>!s::Send, =
>!d::Send, (
>!f::Send, )
>!a::Send, {Raw}!
>!z::Send, _
>!x::Send, -

; !f::Backspace

*/

/*
;// if Alt is still accidentally held down while i press space, send a space instead of popping up system menu (alt+space)
;// exclude command prompt because i use this keyboard shortcut to paste: alt+space,e,p
#IfWinNotActive, ahk_class ConsoleWindowClass
!Space::Send, {Space}
#If
*/



; Alt::return               ;// kill the normal RAlt key function


/*

;http://www.autohotkey.com/board/topic/103174-dual-function-control-key/

$~*LShift::
   ;msgbox, %A_ThisHotkey% is down
   ;// when you hold down the key, this hotkey fires constnatly due to the normal OS-level repeat
   ;// so we only want to store the time from the initial downpress, not each OS-repeat)
   ;// and then during the 'up' hotkey, we reset this timestamp back to 0
   if (!LShift_down_timestamp)      
      LShift_down_timestamp := A_TickCount
   
   ;// if any other modifiers are down along with this key, then we will not send the replacement key
   if (!LShift_modifiers_are_pressed)
      LShift_modifiers_are_pressed := (GetKeyState("Control", "P") ||  GetKeyState("Alt", "P") || GetKeyState("LWin", "P") || GetKeyState("RWin", "P"))
return

$~LShift up::
   ;msgbox, %A_PriorKey%
   ;msgbox, %A_ThisHotkey%
   ;// check if EITHER shift key was the last key pressed
   ;// this allows accidental 'rolling': presing Lshift then Rshift very fast, where you hadn't fully released the LShift before RShift went down
   ;// also, you must press and release LShift within 300ms, otherwise this doesn't trigger. 
   ;// i found myself sometimes holding LShift for a while, planning on capitalizing a letter
   ;// but then releasing the key, causing this hotkey to trigger erroneously
   if (A_PriorKey ~= "LShift|RShift") && (!LShift_modifiers_are_pressed) && (A_TickCount - LShift_down_timestamp < timeout)
      Send, {Shift Down}9{Shift Up}
   LShift_modifiers_are_pressed := false
   LShift_down_timestamp := 0
return


$~*RShift::
   if (!RShift_down_timestamp)      
      RShift_down_timestamp := A_TickCount
   
   if (!RShift_modifiers_are_pressed)
      RShift_modifiers_are_pressed := (GetKeyState("Control", "P") ||  GetKeyState("Alt", "P") || GetKeyState("LWin", "P") || GetKeyState("RWin", "P"))
return

$~RShift up::
   ;msgbox, %A_PriorKey%
   if (A_PriorKey ~= "LShift|RShift") && (!RShift_modifiers_are_pressed) && (A_TickCount - RShift_down_timestamp < timeout)
      Send, {Shift Down}0{Shift Up}
   ;else if (A_PriorKey = "Space")
      ;Send, {Shift Down}0{Shift Up}
   RShift_modifiers_are_pressed := false
   RShift_down_timestamp := 0
return


$~*LAlt::
   ;msgbox down
   ;msgbox, %A_ThisHotkey%
   if (!LAlt_down_timestamp)      
      LAlt_down_timestamp := A_TickCount
   
   ;// if any other modifiers are down along with this key, then we will not send the replacement key
   if (!LAlt_modifiers_are_pressed)
      LAlt_modifiers_are_pressed := (GetKeyState("Control", "P") ||  GetKeyState("Shift", "P") || GetKeyState("LWin", "P") || GetKeyState("RWin", "P"))
return

$~LAlt up::
   ;msgbox, %A_PriorKey%
   ;msgbox, %A_ThisHotkey%
   if (A_PriorKey ~= "LAlt|RAlt") && (!LAlt_modifiers_are_pressed) && (A_TickCount - LAlt_down_timestamp < timeout)
      Send, {Raw}{
   LAlt_modifiers_are_pressed := false
   LAlt_down_timestamp := 0
return


$~*RAlt::
   if (!RAlt_down_timestamp)      
      RAlt_down_timestamp := A_TickCount
   
   if (!RAlt_modifiers_are_pressed)
      RAlt_modifiers_are_pressed := (GetKeyState("Control", "P") ||  GetKeyState("Shift", "P") || GetKeyState("LWin", "P") || GetKeyState("RWin", "P"))
return

$~RAlt up::
   ;msgbox, %A_PriorKey%
   if (A_PriorKey ~= "LAlt|RAlt") && (!RAlt_modifiers_are_pressed) && (A_TickCount - RAlt_down_timestamp < timeout)
      Send, {Raw}}
   RAlt_modifiers_are_pressed := false
   RAlt_down_timestamp := 0
return

*/

/*
;// when rolling RShift+Space to type close-paren then space, sometimes i press Space before i release RShift, and no closing paren gets sent, so fix that
$~Space up::
   if (A_PriorKey = "RShift")
      Send, ){space}
return
*/

;// if you hold down both Shift keys, then release LShift a HALF second before RShift, you will produce the expected ()
;// but if you release LShift and RShift simultaneously, for some reason AHK is sending 0(
;// instead of using  Send, )    this fixes it:   Send, {Shift Down}0{Shift Up}
;// but then that results in )( when usually i would want ()



;// i'm getting a bug where, when i switch into my VM, the first shift+key press is sending both the shifted key as well as the paren
;// for ex: i switch into VM, and then I type Shift+e, I'm seeing E( as a result. its very strange, because you would tink that if i typed it
;// too fast, then the e would be lowercase. the A_PriorKey isn't working or something. but its only for the very first press after the switch
;// also, it only happens if i press the Shift+char fast, if i'm deliberate then it doesn't happen
;// so maybe priorkey is slow and doesn't register as fast as the VM for the very first time


/*
HandleDownpress(hotkey)
{
   hotkey := RegExReplace(hotkey, "i)^[#!^+<>*~$]+| up$", "")
   if (!IsObject(%hotkey%_obj))
      %hotkey%_obj := {}
}
*/


;// create a hotkey to suspend all of these remappings

;// i frequently miss these chars with my pinky:  10!-_=+[](){}
;// i type the wrong ones all the time. perhap use some type of remapping or dual key or alt+ remapping
;// maybe change Alt to [] and then use shift alt for {}
;// or use a deadkey approach
;// OR JUST PRACTICE TYPING THEM BETTER?





/*
DisplayGraphic:
   if GetKeyState("Alt")
   {
      Gui, 1: Show, x0 y0 NoActivate
   }
   else
   {
      Gui, 1: Hide
   }
return
*/

